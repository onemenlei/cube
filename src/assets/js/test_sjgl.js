var PAPER = {
    dataJson: { "data": [{ "createTime": 1526980705467, "isItemUpload": 1, "paperId": 1001526980705466, "paperName": "莲塘一中5月月考_17_10_月考_数学_20180501", "paperEScore": 0.0, "levelId": 1, "xkId": 2, "termId": 2, "xkName": "数学", "paperScore": 150.0, "_id": "1001526980705466", "term": "下学期", "examGradeId": 10, "levelName": "容易", "examGradeName": "高一年级" }, { "createTime": 1526960199237, "isItemUpload": 0, "paperId": 1001526960199236, "paperName": "14_04_月考_数学_20180509", "paperEScore": 0.0, "levelId": 1, "xkId": 2, "termId": 2, "xkName": "数学", "paperScore": 100.0, "_id": "1001526960199236", "term": "下学期", "examGradeId": 4, "levelName": "容易", "examGradeName": "四年级" }, { "createTime": 1526960199236, "isItemUpload": 0, "paperId": 1001526960199235, "paperName": "14_04_月考_语文_20180509", "paperEScore": 0.0, "levelId": 1, "xkId": 1, "termId": 2, "xkName": "语文", "paperScore": 100.0, "_id": "1001526960199235", "term": "下学期", "examGradeId": 4, "levelName": "容易", "examGradeName": "四年级" }, { "createTime": 1526637560564, "isItemUpload": 0, "paperId": 1001526637560563, "paperName": "香城中学_测试_16_11_月考_生物_20180512", "paperEScore": 0.0, "levelId": 1, "xkId": 9, "termId": 2, "xkName": "生物", "paperScore": 100.0, "_id": "1001526637560563", "term": "下学期", "examGradeId": 11, "levelName": "容易", "examGradeName": "高二年级" }, { "createTime": 1526618916443, "isItemUpload": 1, "paperId": 1001526618916442, "paperName": "怀宇分析工具测试CY_16_08_模拟考试_英语_20180516", "paperEScore": 0.0, "levelId": 2, "xkId": 3, "termId": 2, "xkName": "英语", "paperScore": 100.0, "_id": "1001526618916442", "examGradeId": 8, "term": "下学期", "levelName": "较难", "examGradeName": "八年级" }, { "createTime": 1526618916442, "isItemUpload": 0, "paperId": 1001526618916441, "paperName": "怀宇分析工具测试CY_16_08_模拟考试_数学_20180516", "paperEScore": 0.0, "levelId": 1, "xkId": 2, "termId": 2, "xkName": "数学", "paperScore": 150.0, "_id": "1001526618916441", "term": "下学期", "examGradeId": 8, "levelName": "容易", "examGradeName": "八年级" }, { "createTime": 1526618916441, "isItemUpload": 0, "paperId": 1001526618916440, "paperName": "怀宇分析工具测试CY_16_08_模拟考试_语文_20180516", "paperEScore": 0.0, "levelId": 1, "xkId": 1, "termId": 2, "xkName": "语文", "paperScore": 150.0, "_id": "1001526618916440", "term": "下学期", "examGradeId": 8, "levelName": "容易", "examGradeName": "八年级" }, { "createTime": 1526535539326, "isItemUpload": 1, "paperId": 1001526535539325, "paperName": "16_08_单元测试_数学_20180517", "paperEScore": 0.0, "levelId": 1, "xkId": 2, "termId": 2, "xkName": "数学", "paperScore": 150.0, "_id": "1001526535539325", "term": "下学期", "examGradeId": 8, "levelName": "容易", "examGradeName": "八年级" }, { "createTime": 1526528942643, "isItemUpload": 0, "paperId": 1001526528942642, "paperName": "16_11_单元测试_数学_20180517", "paperEScore": 0.0, "levelId": 1, "xkId": 2, "termId": 2, "xkName": "数学", "paperScore": 150.0, "_id": "1001526528942642", "term": "下学期", "examGradeId": 11, "levelName": "容易", "examGradeName": "高二年级" }, { "createTime": 1526528565809, "isItemUpload": 0, "paperId": 1001526528565808, "paperName": "16_08_单元测试_生物_20180517", "paperEScore": 0.0, "levelId": 1, "xkId": 9, "termId": 2, "xkName": "生物", "paperScore": 100.0, "_id": "1001526528565808", "term": "下学期", "examGradeId": 8, "levelName": "容易", "examGradeName": "八年级" }, { "createTime": 1526528565808, "isItemUpload": 0, "paperId": 1001526528565807, "paperName": "16_08_单元测试_政治_20180517", "paperEScore": 0.0, "levelId": 1, "xkId": 8, "termId": 2, "xkName": "政治", "paperScore": 100.0, "_id": "1001526528565807", "term": "下学期", "examGradeId": 8, "levelName": "容易", "examGradeName": "八年级" }, { "createTime": 1526528565807, "isItemUpload": 0, "paperId": 1001526528565806, "paperName": "16_08_单元测试_地理_20180517", "paperEScore": 0.0, "levelId": 1, "xkId": 7, "termId": 2, "xkName": "地理", "paperScore": 100.0, "_id": "1001526528565806", "term": "下学期", "examGradeId": 8, "levelName": "容易", "examGradeName": "八年级" }, { "createTime": 1526528565806, "isItemUpload": 0, "paperId": 1001526528565805, "paperName": "16_08_单元测试_历史_20180517", "paperEScore": 0.0, "levelId": 1, "xkId": 6, "termId": 2, "xkName": "历史", "paperScore": 100.0, "_id": "1001526528565805", "term": "下学期", "examGradeId": 8, "levelName": "容易", "examGradeName": "八年级" }, { "createTime": 1526528565805, "isItemUpload": 0, "paperId": 1001526528565804, "paperName": "16_08_单元测试_化学_20180517", "paperEScore": 0.0, "levelId": 1, "xkId": 5, "termId": 2, "xkName": "化学", "paperScore": 100.0, "_id": "1001526528565804", "term": "下学期", "examGradeId": 8, "levelName": "容易", "examGradeName": "八年级" }, { "createTime": 1526528565804, "isItemUpload": 0, "paperId": 1001526528565803, "paperName": "16_08_单元测试_物理_20180517", "paperEScore": 0.0, "levelId": 1, "xkId": 4, "termId": 2, "xkName": "物理", "paperScore": 100.0, "_id": "1001526528565803", "term": "下学期", "examGradeId": 8, "levelName": "容易", "examGradeName": "八年级" }, { "createTime": 1526528565803, "isItemUpload": 0, "paperId": 1001526528565802, "paperName": "16_08_单元测试_英语_20180517", "paperEScore": 0.0, "levelId": 1, "xkId": 3, "termId": 2, "xkName": "英语", "paperScore": 100.0, "_id": "1001526528565802", "term": "下学期", "examGradeId": 8, "levelName": "容易", "examGradeName": "八年级" }, { "createTime": 1526528565802, "isItemUpload": 0, "paperId": 1001526528565801, "paperName": "16_08_单元测试_数学_20180517", "paperEScore": 0.0, "levelId": 1, "xkId": 2, "termId": 2, "xkName": "数学", "paperScore": 100.0, "_id": "1001526528565801", "term": "下学期", "examGradeId": 8, "levelName": "容易", "examGradeName": "八年级" }, { "createTime": 1526528565801, "isItemUpload": 0, "paperId": 1001526528565800, "paperName": "16_08_单元测试_语文_20180517", "paperEScore": 0.0, "levelId": 1, "xkId": 1, "termId": 2, "xkName": "语文", "paperScore": 100.0, "_id": "1001526528565800", "term": "下学期", "examGradeId": 8, "levelName": "容易", "examGradeName": "八年级" }, { "createTime": 1526019239216, "isItemUpload": 0, "paperId": 1001526019239216, "paperName": "历史测试考试", "paperEScore": 0.0, "levelId": 1, "xkId": 6, "termId": 2, "xkName": "历史", "paperScore": 100.0, "_id": "1001526019239216", "term": "下学期", "examGradeId": 9, "levelName": "容易", "examGradeName": "九年级" }, { "createTime": 1526019178340, "isItemUpload": 0, "paperId": 1001526019178339, "paperName": "15_09_单元测试_化学_20180511", "paperEScore": 0.0, "levelId": 1, "xkId": 5, "termId": 2, "xkName": "化学", "paperScore": 120.0, "_id": "1001526019178339", "term": "下学期", "examGradeId": 9, "levelName": "容易", "examGradeName": "九年级" }], "success": true },
    init: function() {
        console.log(PAPER.dataJson.data);
        PAPER.renderPaperTable(PAPER.dataJson.data);
        PAPER.createPaper();
        PAPER.initDropify();
        PAPER.onClickRuning();
    },
    // 初始化试卷接口数据
    requestPaperTable: function() {
        Tomd.wait('加载中...');
        $.ajax({
            url: '/path/to/file',
            type: 'POST',
            dataType: 'json',
            data: { param1: 'value1' },
            success: function(data) {
                Tomd.waitok();
                // 重新加载
                PAPER.renderPaperTable(res);
            },
            error: function(data) {
                if (data) {
                    Tomd.waitok();
                    Tomd.alert('', '数据加载失败，请稍候再试！', '确定');
                } else if (data) {
                    Tomd.waitok();
                    Tomd.alert('', '网络不给力，请稍候再试！', '确定');
                }
            }
        });
    },
    // 新建试卷
    onClickPaperSaveOk: function() {
        Tomd.wait('加载中...');
        $.ajax({
            url: '/path/to/file',
            type: 'POST',
            dataType: 'json',
            data: { param1: 'value1' },
            success: function(data) {
                Tomd.waitok();
                // 重新加载
                PAPER.renderPaperTable();
            },
            error: function(data) {
                if (data) {
                    Tomd.waitok();
                    Tomd.alert('', '添加失败，请稍候再试！', '确定');
                } else if (data) {
                    Tomd.waitok();
                    Tomd.alert('', '网络不给力，请稍候再试！', '确定');
                }
            }
        });
    },
    // 编辑试卷
    onClickPaperEditOk: function() {
        Tomd.wait('加载中...');
        $.ajax({
            url: '/path/to/file',
            type: 'POST',
            dataType: 'json',
            data: { param1: 'value1' },
            success: function(data) {
                Tomd.waitok();
                // 重新加载
                PAPER.renderPaperTable();
            },
            error: function(data) {
                if (data) {
                    Tomd.waitok();
                    Tomd.alert('', '修改失败，请稍候再试！', '确定');
                } else if (data) {
                    Tomd.waitok();
                    Tomd.alert('', '网络不给力，请稍候再试！', '确定');
                }
            }
        });
    },
    // 导入试卷
    onClickPaperUploadOk: function(id) {
        Tomd.wait('加载中...');
        $.ajax({
            url: '/path/to/file',
            type: 'POST',
            dataType: 'json',
            data: { param1: 'value1' },
            success: function(data) {
                Tomd.waitok();
                // 重新加载
                PAPER.renderPaperTable();
            },
            error: function(data) {
                if (data) {
                    Tomd.waitok();
                    Tomd.alert('', '导入失败，请稍候再试！', '确定');
                } else if (data) {
                    Tomd.waitok();
                    Tomd.alert('', '网络不给力，请稍候再试！', '确定');
                }
            }
        });
    },
    // 删除试卷
    onClickPaperDeleteOk: function(id) {
        Tomd.wait('加载中...');
        $.ajax({
            url: '/path/to/file',
            type: 'POST',
            dataType: 'json',
            data: { param1: 'value1' },
            success: function(data) {
                Tomd.waitok();
                // 重新加载
                PAPER.renderPaperTable();
            },
            error: function(data) {
                if (data) {
                    Tomd.waitok();
                    Tomd.alert('', '删除失败，请稍候再试！', '确定');
                } else if (data) {
                    Tomd.waitok();
                    Tomd.alert('', '网络不给力，请稍候再试！', '确定');
                }
            }
        });
    },
    onClickRuning: function() {
        document.onkeydown = function(evt) {
            var evt = evt ? evt : (window.event ? window.event : null);
            if (evt.keyCode == 13) {
                $('#searchBtn').click();
            }
        }
        $('#searchBtn').click(function() {
            let searchVal = $('#searchValue').val();
            let typeVal = $('#searchType input[name="radio"]:checked').val();
            console.log(searchVal)
            console.log(typeVal)
            PAPER.requestPaperTable();
        });
    },
    // 渲染试卷列表
    renderPaperTable: function(res) {
        // console.log(res);
        $('#paperContent').DataTable({
            'emptyTable': '没有数据',
            'loadingRecords': '加载中...',
            'ordering': false, //不排序    
            'lengthChange': false, //不显示分页下拉列表
            "bAutoWidth": false, //是否自适应宽度
            "info": false, //不显示信息
            "searching": false,  //关闭搜索
            'language': {
                'url': 'datatables_language.json'
            },
            'data': res,
            'columns': [
                { 'data': 'paperId' },
                { 'data': 'xkName' },
                { 'data': 'paperScore' },
                { 'data': 'paperName' },
                { 'data': 'levelName' },
                { 'data': 'examGradeName' },
                { 'data': 'term' },
                { 'data': null },
                { 'data': null }
            ],
            'columnDefs': [{
                    'targets': 7,
                    render: function(data) {
                        var html = `${new Date(data.createTime).Format("yyyy-MM-dd")}`
                        return html;
                    }
                },
                {
                    'targets': -1,
                    render: function(data) {
                        let html = '';
                        if (data.isItemUpload == 1) {
                            html += `<button onclick="PAPER.onClickPaperEdit(${data.paperId})" type="button" class="edit btn btn-primary btn-xs"><i class="iconfont icon-bianji"></i>修改</button><button onclick="PAPER.onClickPaperUpload(${data.paperId})" type="button" class="btn btn-warning btn-xs"><i class="iconfont icon-tuichu"></i"></i>重导结构</button><button data-id="${data.paperId}" type="button" class="btn btn-warning btn-xs"><i class="iconfont icon-tuichu"></i>导出结构</button><button onclick="PAPER.onClickPaperDelete(${data.paperId}, '${data.paperName}')" type="button" class="btn btn-danger btn-xs"><i class="iconfont icon-shanchu"></i>删除</button><button class="btn white_btn btn-xs" type="button" onclick="PAPER.structuralModification_open('${data.paperId}', '${data.paperName}')"><i class="iconfont icon-shezhi"></i>结构修改</button>`;
                        } else {
                            html += `<button onclick="PAPER.onClickPaperEdit(${data.paperId})" type="button" class="edit btn btn-primary btn-xs"><i class="iconfont icon-bianji"></i>修改</button><button onclick="PAPER.onClickPaperUpload(${data.paperId})" type="button" class="btn btn-success btn-xs"><i class="iconfont icon-tuichu"></i>导入结构</button><button data-id="${data.paperId}" type="button" class="btn btn-success btn-xs"><i class="iconfont icon-tuichu"></i>导出结构</button><button onclick="PAPER.onClickPaperDelete(${data.paperId}, '${data.paperName}')" type="button" class="btn btn-danger btn-xs"><i class="iconfont icon-shanchu"></i>删除</button><button class="btn white_btn btn-xs" type="button" onclick="PAPER.structuralModification_open('${data.paperId}', '${data.paperName}')"><i class="iconfont icon-shezhi"></i>结构修改</button>`;
                        }
                        return html;
                    }
                }
            ]
        });
    },
    //试卷结构数据
    tableStructure_data: function(id){
        //导入试卷ID，查出试卷结构数据
        //例 var datas = Men.get_data("../biz/sch/school/getSchoolById",id);
        ///题目编号childNo,卷面题号scoreNo,试题类型编号 type.code,试题类别编号 category.code,分数 score,知识点编号 kps.kpCode 逗号隔开,能力点编号 aps.apCode 逗号隔开,技能 sps.spCode 逗号隔开,分卷 section,客观题标准答案 answer,选择题答案清单（留空为ABCD) choices,是否特殊题 isSpecial：1-是 0-不是,备注 remarks,关键字 itemCode
        var datas = [{"childNo":"1","scoreNo":"1","type":{"code":"C"},"category":{"code":"301"},"score":"101","kps":{"kpCode":[-1,2,3]},"aps":{"apCode":[-1,1,4]},"sps":{"spCode":[-345,49]},"section":"A","answer":"A","choices":"","isSpecial":0,"remarks":"","itemCode":"1001"}
                    ,{"childNo":"2","scoreNo":"2","type":{"code":"D"},"category":{"code":"401"},"score":"25","kps":{"kpCode":[-2,0,3]},"aps":{"apCode":[5,6]},"sps":{"spCode":[9,10]},"section":"B","answer":"A","choices":"BC","isSpecial":1,"remarks":"","itemCode":"1002"}];
        return datas;
    },
    //试卷结构修改窗口
    structuralModification_open: function(id,title){
        var tableStructure = this.tableStructure_data(id);
        var html = template("structuralModification_template",{model:tableStructure,title});
        Men.new_window('试卷结构修改', html, '取消', PAPER.structuralModification_btn);
        $('.center_button_div').prepend('<button class="default_btn edit_row_btn" onclick="Men.alert_ok()">保存</button>');
        $(".center_popup").css('width','90%');
    },
    //试卷结构修改确定按钮
    structuralModification_btn: function(){
        var trs = $("#structuralModification_body tr");
        var Array = [];        
        $.each(trs, function(index, value){
            var jsonArr = {};
            var tdArr = $(this).children();            
            jsonArr.itemCode = tdArr.eq(0).data("imemcode");
            jsonArr.scoreNo = tdArr.eq(1).find('input[type="text"]').val();
            jsonArr.answer = tdArr.eq(9).find('input[type="text"]').val();
            jsonArr.choices = tdArr.eq(10).find('input[type="text"]').val();
            jsonArr.isSpecial = tdArr.eq(11).find('select :selected').val();
            jsonArr.remarks = tdArr.eq(12).find('input[type="text"]').val();
            Array.push(jsonArr);
        });
        // Array就是修改后的数组，传输回数据库 Men.post_data('../biz/sch/school/',Array);  注意，不需要修改的字段里面没有！里面只有需要改掉的字段的内容
        console.info(Array);
        Men.close_window();
    },
    //创建
    createPaper: function() {
        $('#createPaper').click(function() {
            var html = $('#paperTemplate').html();
            Tomd.alert('创建试卷', html, '取消');
            $('.T-modal').off('click');
            $('.T-dialog').addClass('T-dialog-lg');
            $('.T-foot').prepend(`<a onclick="PAPER.onClickPaperSaveOk()">提交</a>`);
        })
    },
    // 编辑
    onClickPaperEdit: function(id) {
        var html = $('#paperTemplate').html();
        Tomd.alert('修改试卷', html, '取消');
        $('.T-modal').off('click');
        $('.T-dialog').addClass('T-dialog-lg');
        $('.T-foot').prepend(`<a onclick="PAPER.onClickPaperEditOk()">提交</a>`);
        PAPER.editTemplate(id);
    },
    editTemplate: function(id) {
        console.log(id);
        let res = PAPER.dataJson.data;
        for (var i = 0; i < res.length; i++) {
            if (res[i].paperId == id) {
                $('#paperName').val(res[i].paperName);
                $('#paperScore').val(res[i].paperScore);
                $('#paperSubject').val(res[i].xkName);
                $('#paperSubject').find(`option[value="${res[i].xkId}"]`).attr("selected", true);
                // $('#paperGrade').val(res[i].examGradeName);
                $('#paperGrade').find(`option[value="${res[i].examGradeId}"]`).attr("selected", true);
                // $('#paperTerm').val(res[i].term);
                $('#paperTerm').find(`option[value="${res[i].termId}"]`).attr("selected", true);
            }
        }
    },
    // 上传导入
    onClickPaperUpload: function(id) {
        // Basic
        Tomd.alert('导入结构', '<input type="file" id="input-file-max-fs" class="dropify" data-max-file-size="2M">', '取消');
        $('.T-modal').off('click');
        $('.T-dialog').addClass('T-dialog-lg');
        $('.T-foot').prepend(`<a onclick="PAPER.onClickPaperUploadOk(${id})">确定</a>`);
        PAPER.initDropify();
    },
    // 删除信息
    onClickPaperDelete: function(id, name) {
        Tomd.alert('', '你确定要删除《' + name + '》吗？', '取消');
        $('.T-modal').off('click');
        $('.T-foot').prepend(`<a onclick="PAPER.onClickPaperDeleteOk(${id})">确定</a>`);
    },
    initDropify: function() {
        //初始化上传
        $('.dropify').dropify({
            messages: {
                'default': '点击或拖拽文件到这里',
                'replace': '点击或拖拽文件到这里来替换文件',
                'remove': '移除文件',
                'error': '对不起，你上传的文件太大了'
            }
        });
    }
}
PAPER.init();